<a name="–†—É—Å—Å–∫–∏–π"></a>

# LLM Book Rewriter (–ü–µ—Ä–µ–ø–∏—Å—á–∏–∫ –ö–Ω–∏–≥ —Å –ü–æ–º–æ—â—å—é LLM)

[Go to English](#english)

## üìñ –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–æ–º–æ—â–∏ –∞–≤—Ç–æ—Ä–∞–º, —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞–º –∏–ª–∏ —á–∏—Ç–∞—Ç–µ–ª—è–º –≤ –ø–∞–∫–µ—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ç–µ–∫—Å—Ç–æ–≤ –∫–Ω–∏–≥ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–æ–ª—å—à–∏—Ö —è–∑—ã–∫–æ–≤—ã—Ö –º–æ–¥–µ–ª–µ–π (LLM). –û–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫, —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è, –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞–Ω–∏–µ) –∫ –±–æ–ª—å—à–∏–º —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Ñ–∞–π–ª–∞–º, —Ä–∞–∑–±–∏–≤–∞—è –∏—Ö –Ω–∞ —É–ø—Ä–∞–≤–ª—è–µ–º—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—è –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç —á–µ—Ä–µ–∑ LLM –∏ —Å–æ–±–∏—Ä–∞—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ. –ù–∞–ø—Ä–∏–º–µ—Ä, —á–∏—Ç–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –∫—É–ø–ª–µ–Ω–Ω—É—é –∫–Ω–∏–≥—É –≤ FB2, –∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ –Ω–µ–π –æ—à–∏–±–∫–∏ —Å –ø–æ–º–æ—â—å—é –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ —á–∏—Ç–∞—Ç—å.

**–ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**

*   **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º–∏ (Chunking):** –†–∞–∑–±–∏–≤–∞–µ—Ç –±–æ–ª—å—à–∏–µ —Ç–µ–∫—Å—Ç—ã –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞, —Å—Ç–∞—Ä–∞—è—Å—å —É—á–∏—Ç—ã–≤–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏–ª–∏ —Ç–µ–≥–æ–≤.
*   **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å LLM:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Google Gemini –∏ OpenRouter –≤ –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ LLM.
*   **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `asyncio` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤, –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É—Å–∫–æ—Ä—è—è –ø—Ä–æ—Ü–µ—Å—Å.
*   **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ü—Ä–æ–º–ø—Ç:** –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Ç–æ—á–Ω–æ —É–∫–∞–∑–∞—Ç—å LLM, –∫–∞–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–Ω–µ—Å—Ç–∏ –≤ —Ç–µ–∫—Å—Ç.
*   **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤:** –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ñ–∞–π–ª–∞–º–∏ `.fb2`, `.txt` –∏ `.docx`.
*   **–≠–≤—Ä–∏—Å—Ç–∏–∫–∏:** –ü—Ä–∏–º–µ–Ω—è–µ—Ç –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –¥–æ –∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
*   **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:** –ö–µ—à–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã, –ø–æ–∑–≤–æ–ª—è—è –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
*   **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä—ã:** –£–º–µ–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ API (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–∏–º–∏—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤) –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞.
*   **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–≥–æ–≤:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ LLM –Ω–µ –¥–æ–±–∞–≤–∏–ª–∞ –∏ –Ω–µ —É–¥–∞–ª–∏–ª–∞ —Ç–µ–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö, –≥–¥–µ –æ–Ω–∏ –≤–∞–∂–Ω—ã (`fb2`, `docx`).
*   **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:** –°—Ç–∞—Ä–∞–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤–æ–∫—Ä—É–≥ —Ç–µ–∫—Å—Ç–∞ –∏ —Ç–µ–≥–æ–≤ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ LLM.

## üì¶ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã

*   **FB2:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–≥–∞ `<body>`, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ–≥–æ –∏ –∑–∞–º–µ–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω–æ–µ —Ç–µ–ª–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º. (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `lxml` –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ XML).
*   **TXT:** –ß–∏—Ç–∞–µ—Ç –≤–µ—Å—å —Ñ–∞–π–ª –∫–∞–∫ –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω–æ–≤—ã–π —Ñ–∞–π–ª.
*   **DOCX:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ —á–∞—Å—Ç—è–º (`run`), –≤—Å—Ç–∞–≤–ª—è—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏ `<RUN/>` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è. –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ LLM –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö `run`. (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `python-docx`).

## üîë API –ö–ª—é—á–∏ –∏ –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã LLM

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ LLM:

1.  **Google Gemini:**
    *   **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞:**
        1.  –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: [https://aistudio.google.com/apikey](https://aistudio.google.com/apikey)
        2.  –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º Google –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∞—à–µ–≥–æ API-–∫–ª—é—á–∞.
    *   **–ú–æ–¥–µ–ª–∏ (–ø—Ä–∏–º–µ—Ä—ã):** `models/gemini-2.0-flash`, `models/gemini-2.5-pro-exp-03-25`.
    *   **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ):**
        *   `models/gemini-2.0-flash`: ~1500 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å.
        *   `models/gemini-2.5-pro-exp-03-25`: ~25 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å.
2.  **OpenRouter:**
    *   **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞:** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [OpenRouter.ai](https://openrouter.ai/) –∏ –ø–æ–ª—É—á–∏—Ç–µ API-–∫–ª—é—á.
    *   **–ú–æ–¥–µ–ª–∏ (–ø—Ä–∏–º–µ—Ä—ã):** `deepseek/deepseek-chat-v3-0324:free`, `google/gemini-flash-1.5`. OpenRouter –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –º–Ω–æ–∂–µ—Å—Ç–≤—É –º–æ–¥–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ.
    *   **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–ø—Ä–∏–º–µ—Ä–Ω—ã–µ):** ~50 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å –Ω–∞ –º–æ–¥–µ–ª–∏ –∏–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "Free".

## ‚ùó –í–∞–∂–Ω—ã–µ –ó–∞–º–µ—á–∞–Ω–∏—è

*   **–î–æ—Å—Ç—É–ø –∫ API:** –í **–†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏** –¥–æ—Å—Ç—É–ø –∫ API Google Gemini –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç **–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω**. –í **–ù–∏–¥–µ—Ä–ª–∞–Ω–¥–∞—Ö**, –≤–ø—Ä–æ—á–µ–º, –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç. OpenRouter –º–æ–∂–µ—Ç —Å–ª—É–∂–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–æ–π.
*   **–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (Google):** –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ —Å—Ç—Ä–∞–Ω –ï–≤—Ä–æ–ø–µ–π—Å–∫–æ–π —ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–æ–π –∑–æ–Ω—ã (EEA)(**–∏ –ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã —Å—é–¥–∞ –≤—Ö–æ–¥—è—Ç**), –®–≤–µ–π—Ü–∞—Ä–∏–∏ –∏–ª–∏ –í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏–∏, Google –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å–≤–æ–µ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π, **–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π.**
*   **–§–∏–ª—å—Ç—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (Google Gemini):** –ú–æ–¥–µ–ª–∏ Gemini –∏–º–µ—é—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ò–Ω–æ–≥–¥–∞ –æ–Ω–∏ –º–æ–≥—É—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å **—Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ**, –±–ª–æ–∫–∏—Ä—É—è –¥–∞–∂–µ –±–µ–∑–æ–±–∏–¥–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ç–µ–∫—Å—Ç–∞. –ï—Å–ª–∏ –≤—ã —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å —Å —á–∞—Å—Ç—ã–º–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥—É—é –º–æ–¥–µ–ª—å (Flash) –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ OpenRouter, –≥–¥–µ –ø–æ–ª–∏—Ç–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è.
*   **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Google Docs (–¥–ª—è DOCX):** –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ä–∞–≤–Ω–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π `.docx` –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ "–°—Ä–∞–≤–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã" –≤ Google Docs, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± (–∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–∞) –º–æ–∂–µ—Ç –Ω–µ –ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –ß—Ç–æ–±—ã —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–ª–æ –Ω–∞–¥–µ–∂–Ω–æ:
    1.  –ó–∞–≥—Ä—É–∑–∏—Ç–µ *–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π* —Ñ–∞–π–ª (`.docx`) –≤ Google Docs.
    2.  **–°–∫–∞—á–∞–π—Ç–µ** –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ Google Docs –≤ —Ñ–æ—Ä–º–∞—Ç–µ `.docx`. –≠—Ç–æ—Ç —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –±—É–¥–µ—Ç –≤–∞—à–µ–π "–±–∞–∑–æ–≤–æ–π" –≤–µ—Ä—Å–∏–µ–π –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.
    3.  –ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π —Ñ–∞–π–ª (`_rewritten.docx`).
    4.  –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã" -> "–°—Ä–∞–≤–Ω–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã", –≤—ã–±—Ä–∞–≤ —Å–∫–∞—á–∞–Ω–Ω—ã–π –Ω–∞ —à–∞–≥–µ 2 —Ñ–∞–π–ª –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±–∞–∑–æ–≤–æ–≥–æ –∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –Ω–∞ —à–∞–≥–µ 3 —Ñ–∞–π–ª –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º–æ–≥–æ.

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

1.  –ü–æ–ª–æ–∂–∏—Ç–µ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã (`.exe`) –≤ –æ–¥–Ω—É –ø–∞–ø–∫—É —Å config.yaml
2.  –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `config.yaml` –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∏ –≤–Ω–µ—Å–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
    *   **`google.api_key` / `openrouter.api_key`:** –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à API-–∫–ª—é—á –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö.
    *   **`processing.provider`:** –£–∫–∞–∂–∏—Ç–µ `google` –∏–ª–∏ `openrouter`.
    *   **`google.model` / `openrouter.model`:** –£–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é –º–æ–¥–µ–ª—å LLM (—Å–º. –ø—Ä–∏–º–µ—Ä—ã –≤—ã—à–µ).
    *   **`processing.chunk_size`:** –†–∞–∑–º–µ—Ä —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –≤ —Å–∏–º–≤–æ–ª–∞—Ö. **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 8000.** –ú–µ–Ω—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç —É–ª—É—á—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ —É–≤–µ–ª–∏—á–∞—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤—Ä–µ–º—è. –ë–æ–ª—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —É—Å–∫–æ—Ä—è—é—Ç, –Ω–æ –º–æ–≥—É—Ç —É—Ö—É–¥—à–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ.
    *   **`processing.workers_amount`:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API. –í—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è **–ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Å–∫–æ—Ä–æ—Å—Ç—å** –æ–±—Ä–∞–±–æ—Ç–∫–∏. –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –ø—Ä–∏ –ª—é–±—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö, –Ω–æ —Å–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–µ –º–æ–≥—É—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –±–æ–ª—å—à–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ—à–∏–±–æ–∫ (Resourse Exhausted) –≤ –∫–æ–Ω—Å–æ–ª–∏.
        *   –î–ª—è "–º–µ–¥–ª–µ–Ω–Ω—ã—Ö" –º–æ–¥–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `gemini-2.5-pro-exp-03-25`): —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è **1-3**.
        *   –î–ª—è "–±—ã—Å—Ç—Ä—ã—Ö" –º–æ–¥–µ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `gemini-2.0-flash`): —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è **10-20**.
    *   **`processing.number_of_passes`:** –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫–∞–∂–¥—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω LLM. –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –±–æ–ª—å—à–µ 1 **–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ**. –û—Å—Ç–∞–≤—å—Ç–µ **1**.
    *   **`processing.output_dir`:** –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"output_books"`).
    *   **`processing.retry_if_failed`:** `True` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è), —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä—è—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ, `False` - —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç (–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º).
    *   **`processing.docx_merge_runs`:** `True` (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è), —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Å–ª–∏—è–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö 'run'-–æ–≤ (–µ–¥–∏–Ω–∏—Ü–∞ —Ç–µ–∫—Å—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ docx), `False` - —á—Ç–æ–±—ã –≤—ã–∫–ª—é—á–∏—Ç—å (–æ—Å—Ç–∞–≤–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ).

    **‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ!** –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —è–≤–ª—è–µ—Ç—Å—è **—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π**, –Ω–æ –µ—ë –≤–∫–ª—é—á–µ–Ω–∏–µ (`True`) **–ö–†–ê–ô–ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø**.

    **–ß—Ç–æ –æ–Ω–∞ –¥–µ–ª–∞–µ—Ç?** –û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ—Å–µ–¥–Ω–∏–µ —É—á–∞—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ (—ç–ª–µ–º–µ–Ω—Ç—ã `<run>` –≤ DOCX), –µ—Å–ª–∏ —É –Ω–∏—Ö **–ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** (—à—Ä–∏—Ñ—Ç, —Ä–∞–∑–º–µ—Ä, —Ü–≤–µ—Ç, —Å—Ç–∏–ª—å –∏ —Ç.–¥.).

    **–ü–æ—á–µ–º—É —ç—Ç–æ —Ç–∞–∫ –≤–∞–∂–Ω–æ?**
    *   **üöÄ –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ–≤—ã—à–∞–µ—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –£–±–∏—Ä–∞–µ—Ç "—à—É–º" –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –ø–æ–∑–≤–æ–ª—è—è –º–æ–¥–µ–ª—è–º –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ–¥–∏–Ω–æ–µ —Ü–µ–ª–æ–µ.
    *   **üí∞ –°–Ω–∏–∂–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏:** –£–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É–∂–µ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ –æ–±—â—É—é –¥–ª–∏–Ω—É —Ç–µ–∫—Å—Ç–∞, –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º–æ–≥–æ –º–æ–¥–µ–ª–∏.

    **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ–∫:** –ë—É–¥—É—á–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π, —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø–æ—Ç–µ—Ä–µ *–Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö* —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö(–∏—Å—Ç–æ—Ä–∏—è –ø—Ä–∞–≤–æ–∫, –∏—Å—Ç–æ—á–Ω–∏–∫), —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –≥—Ä–∞–Ω–∏—Ü–∞–º–∏ –∏—Å—Ö–æ–¥–Ω—ã—Ö `<run>`. –û–¥–Ω–∞–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ü–≤–µ—Ç, —Å—Ç–∏–ª—å, —Ä–∞–∑–º–µ—Ä –∏ —Ç.–¥.) –ø—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ **–¥–æ–ª–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è**, —Ç–∞–∫ –∫–∞–∫ –æ–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏.

    **–ù–∞–≥–ª—è–¥–Ω—ã–π –ø—Ä–∏–º–µ—Ä:**
    –î–æ–ø—É—Å—Ç–∏–º, –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ –µ—Å—Ç—å —Å—Ç—Ä–æ–∫–∞ "–ú–∞—à–∞ –µ–ª–∞ –∫–∞—à—É". –ò–∑-–∑–∞ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏, –≤–Ω—É—Ç—Ä–∏ DOCX –æ–Ω–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–æ `<run>` (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã `<w:r>`, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º `<RUN>`):
    `<RUN1/>–ú<RUN2/>–ê–®</RUN2>–ê –ï–õ–ê –ö–ê<RUN3/>–®–£`

    *   **–ë–µ–∑ —Å–ª–∏—è–Ω–∏—è (`False`):** –ú–æ–¥–µ–ª—å –ø–æ–ª—É—á–∏—Ç –Ω–µ—á—Ç–æ –≤—Ä–æ–¥–µ `@–ú@–ê–®@–ê –ï–õ–ê –ö–ê@–®–£` (—É—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ, —Ä–µ–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–∞, –Ω–æ —Å—É—Ç—å –≤ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏).
        *   –≠—Ç–æ **—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å** –∏–∑-–∑–∞ –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö/—Ç–æ–∫–µ–Ω–æ–≤.
        *   –ú–æ–¥–µ–ª–∏ **–∫—Ä–∞–π–Ω–µ —Å–ª–æ–∂–Ω–æ** –∞–¥–µ–∫–≤–∞—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–∞–∫–æ–π "—Ä–≤–∞–Ω—ã–π" —Ç–µ–∫—Å—Ç. –†–µ–∑—É–ª—å—Ç–∞—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–º: –±—É–∫–≤—ã –ø–µ—Ä–µ—Å—Ç–∞–≤—è—Ç—Å—è, —Å–ª–æ–≤–∞ –∏—Å–∫–∞–∑—è—Ç—Å—è, —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç "–ø–µ—Ä–µ–ø—Ä—ã–≥–Ω—É—Ç—å" –≤ –¥—Ä—É–≥–æ–π –∞–±–∑–∞—Ü –∏–ª–∏ –≤–æ–≤—Å–µ –∏—Å—á–µ–∑–Ω—É—Ç—å.

    *   **–°–æ —Å–ª–∏—è–Ω–∏–µ–º (`True`):** –ï—Å–ª–∏ –≤—Å–µ —ç—Ç–∏ `<RUN>` –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ—É–Ω–∫—Ü–∏—è –æ–±—ä–µ–¥–∏–Ω–∏—Ç –∏—Ö:
        `<RUN/>–ú–∞—à–∞ –µ–ª–∞ –∫–∞—à—É`
        –¢–∞–∫–æ–π —Ç–µ–∫—Å—Ç –º–æ–¥–µ–ª—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç **–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –Ω–∞–¥–µ–∂–Ω–æ –∏ –¥–µ—à–µ–≤–ª–µ**.

    **–í—ã–≤–æ–¥:** –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å—Ç–∞—Ç—É—Å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π, **–Ω–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** –æ—Å—Ç–∞–≤–ª—è—Ç—å —ç—Ç—É –æ–ø—Ü–∏—é –≤–∫–ª—é—á–µ–Ω–Ω–æ–π (`True`) –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –∑–∞–¥–∞—á –æ–±—Ä–∞–±–æ—Ç–∫–∏ DOCX-—Ñ–∞–π–ª–æ–≤.
    *   **`prompt`:** **–û—á–µ–Ω—å –≤–∞–∂–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä.** –≠—Ç–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è LLM.
        *   –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –ø–æ–¥ –≤–∞—à–∏ –∑–∞–¥–∞—á–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫, –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ, —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏ —Ç.–¥.).
        *   –ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `{text_chunk}`, –∫—É–¥–∞ –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞.
        *   –ü—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—á–µ–Ω—å –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –∏ —Å—Ç—Ä–µ–º–∏—Ç—Å—è —Å–≤–µ—Å—Ç–∏ –∫ –Ω—É–ª—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è, –¥–∞–∂–µ –ø—Ä–∏ –æ–±–æ—Ä–æ—Ç–∞—Ö –≤—Ä–æ–¥–µ "—Å–∫—Ä–∏–ø—è —Å–µ—Ä–¥—Ü–µ–º". –í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∑–∞—Ö–æ—Ç–∏—Ç–µ –ø–æ–º–µ–Ω—è—Ç—å –µ–≥–æ.
        *   **–í–∞–∂–Ω–æ:** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–æ–º–ø—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –ï—Å–ª–∏ –≤—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ –¥—Ä—É–≥–æ–º —è–∑—ã–∫–µ, **–ø–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç –Ω–∞ —ç—Ç–æ—Ç —è–∑—ã–∫**, –≤–∫–ª—é—á–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é —Ç–µ–≥–æ–≤ –∏ –ø—Ä–æ–±–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤. –ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞–±–æ—Ç—ã LLM —Å–∏–ª—å–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —è–∑—ã–∫–∞ –∏ —á–µ—Ç–∫–æ—Å—Ç–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.
    *   **`heuristics`:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫ (—Å–º. –Ω–∏–∂–µ). –í–∫–ª—é—á–∞—é—Ç—Å—è/–≤—ã–∫–ª—é—á–∞—é—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π `True` –∏–ª–∏ `False`.

## ‚ú® –≠–≤—Ä–∏—Å—Ç–∏–∫–∏

–≠–≤—Ä–∏—Å—Ç–∏–∫–∏ - —ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ *–¥–æ* –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ LLM (preprocessing) –∏ *–ø–æ—Å–ª–µ* –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ (postprocessing), –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–ª—è **—É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏**. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –≤ —Ñ–∞–π–ª–µ `config.yaml` –≤ —Å–µ–∫—Ü–∏–∏ `heuristics`.

*   **`remove_commas` (Preprocessing, —Ç–æ–ª—å–∫–æ 1-–π –ø—Ä–æ—Ö–æ–¥):**
    *   **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:** –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–∞–ø—è—Ç—ã–µ –∏–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ *–ø–µ—Ä–µ–¥* –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ LLM (—Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤–æ–º –ø—Ä–æ—Ö–æ–¥–µ, –µ—Å–ª–∏ `number_of_passes: 1`).
    *   **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ú–æ–∂–µ—Ç —É–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –µ—Å–ª–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ **–º–Ω–æ–≥–æ –ª–∏—à–Ω–∏—Ö –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—è—Ç—ã—Ö**, –∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –º–æ–¥–µ–ª—å —Ä–∞—Å—Å—Ç–∞–≤–∏–ª–∞ –∏—Ö –∑–∞–Ω–æ–≤–æ "—Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞". **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Å–∏–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `gemini-2.5-pro-exp-03-25`), –∫–æ—Ç–æ—Ä—ã–µ –ª—É—á—à–µ —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏.
    *   **–ü—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è:** –°–ª–∞–±—ã–µ –º–æ–¥–µ–ª–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø—è—Ç—ã–µ –æ–±—Ä–∞—Ç–Ω–æ –∏–ª–∏ —Ä–∞—Å—Å—Ç–∞–≤–∏—Ç—å –∏—Ö –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ.
*   **`replace_tags_with_placeholder` (Preprocessing + Postprocessing):**
    *   **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
        *   *Preprocessing:* –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Ç–µ–≥–∏ –≤–∏–¥–∞ `<...>` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `<p>`, `</emphasis>`, `<RUN123/>`) –∏ –∑–∞–º–µ–Ω—è–µ—Ç –∏—Ö –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `@`, `#`, `$`). –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ç–µ–≥–∞—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
        *   *Postprocessing:* –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç LLM, –∑–∞–º–µ–Ω—è–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ.
    *   **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** **–ù–∞—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ FB2 –∏ DOCX.** LLM —á–∞—Å—Ç–æ –ø–ª–æ—Ö–æ —Å–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º HTML/XML-–ø–æ–¥–æ–±–Ω—ã—Ö —Ç–µ–≥–æ–≤. –≠—Ç–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ "–ø—Ä—è—á–µ—Ç" —Ç–µ–≥–∏ –æ—Ç LLM. **–°–ª–∞–±—ã–µ –º–æ–¥–µ–ª–∏ (–æ–±—ã—á–Ω–æ –ª–æ–∫–∞–ª—å–Ω—ã–µ) –±–µ–∑ —ç—Ç–æ–π —ç–≤—Ä–∏—Å—Ç–∏–∫–∏ –º–æ–≥—É—Ç –≤–æ–æ–±—â–µ –Ω–µ —Å–ø—Ä–∞–≤–∏—Ç—å—Å—è —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤.**
    *   **–ü—Ä–µ–¥–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–∏—è:** –ï—Å–ª–∏ LLM —É–¥–∞–ª–∏—Ç –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç —Å–∏–º–≤–æ–ª-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –≤ —Ç–µ–∫—Å—Ç–µ, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –Ω–µ —É–¥–∞—Å—Ç—Å—è, –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è (`validate_response`) —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ–≤–∞–ª–∏—Ç—Å—è.

## üöÄ –ó–∞–ø—É—Å–∫

1.  –ü–æ–º–µ—Å—Ç–∏—Ç–µ –≤–∞—à–∏ –∫–Ω–∏–≥–∏ (`.fb2`, `.txt`, `.docx`) –≤ –æ–¥–Ω—É –ø–∞–ø–∫—É —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —Ñ–∞–π–ª–æ–º –ø—Ä–æ–≥—Ä–∞–º–º—ã (`.exe`) –∏ —Ñ–∞–π–ª–æ–º `config.yaml`.
2.  –ó–∞–ø—É—Å—Ç–∏—Ç–µ `.exe` —Ñ–∞–π–ª.
3.  –ü—Ä–æ–≥—Ä–∞–º–º–∞ –Ω–∞—á–Ω–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º. –í—ã –±—É–¥–µ—Ç–µ –≤–∏–¥–µ—Ç—å –ª–æ–≥–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏.
4.  –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫–µ, —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ `processing.output_dir` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `output_books`), —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º `_rewritten` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `my_book_rewritten.fb2`).
5.  **–ö–µ—à:** –í–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–∞–ø–∫–∞ `book_temp`, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è –ø–æ–¥–ø–∞–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏ —Å –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞–º–∏ (`chunkXXXXX.txt`). –ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–µ—Ä–≤–µ—Ç—Å—è, –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ—á–∏—Ç–∞–µ—Ç —ç—Ç–∏ —Ñ–∞–π–ª—ã –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∞—Å—å. **–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ**: –û—Ç–∫—Ä–æ–π—Ç–µ –≤ —Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Word/Google Docs –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∫–∏.
6.  **–°–±—Ä–æ—Å –∫–µ—à–∞:** –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∫–Ω–∏–≥–∏ –∑–∞–Ω–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫), —É–¥–∞–ª–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –ø–æ–¥–ø–∞–ø–∫—É –≤–Ω—É—Ç—Ä–∏ `book_temp` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `book_temp/my_book_name/`).

## üîß –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ù–µ–ø–æ–ª–∞–¥–æ–∫

*   **`RESOURCE_EXHAUSTED` (–û—à–∏–±–∫–∞ 429 –≤ –ª–æ–≥–∞—Ö):** –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API, –∏–ª–∏ –∏—Å—á–µ—Ä–ø–∞–Ω –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∏–ª–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ –ø—Ä–∏ –ø–ª–∞—Ç–Ω–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏. –£–º–µ–Ω—å—à–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ `processing.workers_amount` –≤ `config.yaml` –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∏—Ç–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è/–ø–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å.
*   **–°–æ–æ–±—â–µ–Ω–∏—è –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –æ—Ç Google (Filter):** –°—Ä–∞–±–æ—Ç–∞–ª —Ñ–∏–ª—å—Ç—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Google Gemini. –°–º. —Ä–∞–∑–¥–µ–ª "–í–∞–∂–Ω—ã–µ –ó–∞–º–µ—á–∞–Ω–∏—è". –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–æ–º–ø—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥—É—é –º–æ–¥–µ–ª—å –∏–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (OpenRouter).
*   **`ValidationFailedError`:** LLM –∏–∑–º–µ–Ω–∏–ª–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–≥–æ–≤ `<` –∏–ª–∏ `>`. –ß–∞—Å—Ç–æ —Å–ª—É—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ `replace_tags_with_placeholder` –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è FB2/DOCX, –∏–ª–∏ –µ—Å–ª–∏ LLM –¥–æ–±–∞–≤–∏–ª–∞/—É–¥–∞–ª–∏–ª–∞ —Å–∏–º–≤–æ–ª-–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π —ç–≤—Ä–∏—Å—Ç–∏–∫–µ. –ò–Ω–æ–≥–¥–∞ —Å–ª—É—á–∞–µ—Ç—Å—è, –æ–±—ã—á–Ω–æ —Å–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ø—ã—Ç–∫–∏ –º–æ–¥–µ–ª—å —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –¥–ª—è FB2/DOCX –∏ –ø—Ä–æ–º–ø—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —á–µ—Ç–∫—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–≥–∏/–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã.
*   **–ú–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:** –£–≤–µ–ª–∏—á—å—Ç–µ `processing.workers_amount` (–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ!) –∏–ª–∏ `processing.chunk_size`. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–µ –º–æ–¥–µ–ª–∏ (Flash –≤–º–µ—Å—Ç–æ Pro).

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–¥ –ª–∏—Ü–µ–Ω–∑–∏–µ–π MIT. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–º. –≤ —Ñ–∞–π–ª–µ `LICENSE`.

---

<a name="english"></a>

# LLM Book Rewriter

[Go to –†—É—Å—Å–∫–∏–π](#–†—É—Å—Å–∫–∏–π)

## üìñ Description

This program is designed to assist authors, editors, or readers in batch processing book texts using large language models (LLM). It automates the process of applying changes (e.g., error correction, stylization, paraphrasing) to large text files by breaking them down into manageable chunks, processing each chunk via an LLM, and reassembling the result. For example, a reader can download a purchased book in FB2 format, correct errors in it using the program, and read it comfortably.

**Key Features:**

*   **Chunking:** Splits large texts into chunks of a specified size, attempting to respect sentence or tag boundaries.
*   **LLM Integration:** Supports Google Gemini and OpenRouter as LLM providers.
*   **Asynchronous Processing:** Uses `asyncio` for parallel chunk processing, significantly speeding up the process.
*   **Customizable Prompt:** Allows the user to specify exactly what changes the LLM should make to the text.
*   **Format Support:** Works with `.fb2`, `.txt`, and `.docx` files.
*   **Heuristics:** Applies optional heuristics before and after LLM processing to improve output quality.
*   **State Persistence:** Caches processed chunks, allowing work to be resumed after interruption without losing progress.
*   **Error Handling and Retries:** Handles API errors (e.g., rate limits) and automatically retries failed chunk processing attempts.
*   **Tag Validation:** Verifies that the LLM has not added or removed tags in formats where they are important (`fb2`, `docx`).
*   **Formatting Preservation:** Attempts to preserve original whitespace around text and tags when formatting the LLM response.

## üì¶ Supported Formats

*   **FB2:** Extracts the content of the `<body>` tag, processes it, and replaces the original body with the processed text. (Uses the `lxml` library for XML parsing).
*   **TXT:** Reads the entire file as plain text, processes it, and writes the result to a new file.
*   **DOCX:** Processes text in parts (`run`), inserting temporary `<RUN/>` tags for tracking. After LLM processing, it replaces the text in the corresponding `run`s. (Uses the `python-docx` library).

## üîë API Keys and LLM Providers

The program supports two LLM providers:

1.  **Google Gemini:**
    *   **Getting a Key:**
        1.  Go to the link: [https://aistudio.google.com/apikey](https://aistudio.google.com/apikey)
        2.  Follow Google's instructions to create and obtain your API key.
    *   **Models (examples):** `models/gemini-1.0-pro`, `models/gemini-1.5-flash-latest`.
    *   **Free Tier Limits (approximate):**
        *   `models/gemini-1.5-flash-latest`: ~60 requests per minute (RPM). Limits might vary.
        *   `models/gemini-1.0-pro`: ~2 RPM.
2.  **OpenRouter:**
    *   **Getting a Key:** Register at [OpenRouter.ai](https://openrouter.ai/) and obtain an API key.
    *   **Models (examples):** `google/gemini-flash-1.5`, `anthropic/claude-3-haiku`. OpenRouter provides access to numerous models, including free and paid ones with varying limits.
    *   **Free Tier Limits (approximate):** Varies by model. Check the OpenRouter models page for details on free tier availability and limits.

## ‚ùó Important Notes

*   **API Access:** Access to the Google Gemini API may be restricted in certain regions (e.g., **Russian Federation** at the time of writing). It is confirmed to work in regions like the **Netherlands**. OpenRouter can serve as an alternative.
*   **Data Privacy (Google):** When making requests from countries in the European Economic Area (EEA) (**including the Netherlands**), Switzerland, or the UK, Google, according to its policy, **does not use your data for model training.** Check Google's current policies for confirmation.
*   **Content Filters (Google Gemini):** Gemini models have built-in safety filters. Sometimes they can be **overly aggressive**, blocking even harmless text fragments. If you encounter frequent blocks (`"finish_reason": "SAFETY"`), try simplifying the prompt, using a different model (Flash often has less strict filtering than Pro), adjusting safety settings if available via the API, or switching to OpenRouter, where filtering policies may differ or be configurable.
*   **Google Docs Change Tracking (for DOCX):** If you want to compare the original `.docx` and the processed file using the 'Compare documents' feature in Google Docs, the standard method (uploading both) might not show changes correctly due to internal differences in how Word and Google Docs handle DOCX structures. For reliable comparison:
    1.  Upload the *original* file (`.docx`) to Google Docs.
    2.  **Download** it back from Google Docs in `.docx` format. This downloaded file will be your "base" version for comparison.
    3.  Upload the file processed by this program (`_rewritten.docx`).
    4.  Use the 'Tools' -> 'Compare documents' feature in Google Docs, selecting the file downloaded in step 2 as the base and the file uploaded in step 3 as the comparison document.

## ‚öôÔ∏è Configuration

1.  Place the program's executable file (`.exe` or the script) in the same folder as `config.yaml`.
2.  Open the `config.yaml` file in a text editor and make the necessary changes:
    *   **`google.api_key` / `openrouter.api_key`:** Paste your API key for the chosen provider within quotes. Leave empty or remove if not using that provider.
    *   **`processing.provider`:** Specify `google` or `openrouter`.
    *   **`google.model` / `openrouter.model`:** Specify the desired LLM model ID (see examples above or provider documentation).
    *   **`processing.chunk_size`:** Chunk size in characters. **Recommended value: 8000.** Smaller values might improve processing quality (especially for complex prompts) but increase the number of API calls and total time. Larger values speed things up but may decrease quality or hit model context limits.
    *   **`processing.workers_amount`:** Number of concurrent requests to the API. High values **potentially increase processing speed**. The program is stable at any value, but excessively high values can lead to many errors (e.g., `429 Resource Exhausted`, `500 Internal Server Error`) in the console, especially if hitting API rate limits.
        *   For "slow" or rate-limited models (e.g., Gemini Pro free tier): **1-3** is recommended.
        *   For "fast" or higher-limit models (e.g., Gemini Flash, paid tiers): **10-20** or more might work, depending on your specific API limits. Adjust based on observed errors.
    *   **`processing.number_of_passes`:** How many times each chunk will be processed by the LLM. In the current version, a value greater than 1 has **limited practical use** unless specifically designed into the prompt or workflow. Leave it as **1** for standard rewriting.
    *   **`processing.output_dir`:** Folder for saving processed files (e.g., `"output_books"`).
    *   **`processing.retry_if_failed`:** `True` (recommended) to retry processing a chunk on recoverable API errors (like rate limits or temporary server issues), `False` to skip the chunk (leave it original) upon failure.
    *   **`processing.docx_merge_runs`:** `True` (recommended) to enable merging of adjacent identically formatted runs in DOCX files before processing, `False` to disable (process runs as they are).

    **‚ö†Ô∏è Warning!** This feature is **experimental**, but enabling it (`True`) is **HIGHLY RECOMMENDED** for DOCX processing.

    **What it does:** Merges adjacent text segments ( `<w:r>` or "run" elements in DOCX) if their **formatting is completely identical** (font, size, color, bold, italics, etc.).

    **Why is it important?**
    *   **üöÄ Significantly improves quality and stability:** Reduces document "noise," allowing the LLM to process text more coherently. Avoids issues caused by excessive fragmentation.
    *   **üí∞ Reduces processing cost:** Decreases the amount of redundant formatting information and the overall text length sent to the LLM, potentially lowering token usage.

    **Potential drawback:** Being experimental, the feature could theoretically lead to the loss of *some* specific metadata (like detailed edit history or certain complex field information) tied to the original `<w:r>` boundaries. However, the main visual formatting (color, style, size, etc.) **should be preserved** during merging, as only identically formatted runs are combined.

    **Illustrative Example:**
    Suppose a document contains the line "Mary ate porridge". Due to formatting quirks, copy-pasting, or conversion, within the DOCX XML, it might be split into multiple runs:
    `<RUN1>M</RUN1><RUN2>ary</RUN2> ate porr<RUN3>idge</RUN3>`

    *   **Without merging (`False`):** The preprocessor might send something like `@M@ary@ ate porr@idge@` to the LLM (simplified representation; actual output depends on preprocessing, but the core issue is fragmentation).
        *   This **increases cost** due to extra placeholder/tag data.
        *   LLMs often **struggle** to process such fragmented text correctly. The result can be unpredictable: letters might get swapped, words distorted, text might jump paragraphs or disappear entirely.

    *   **With merging (`True`):** If all these runs have identical formatting, the function merges them:
        `<RUN>Mary ate porridge</RUN>`
        The LLM receives coherent text, which it can process **correctly, reliably, and more cheaply**.

    **Conclusion:** Despite its experimental status, it is **strongly recommended** to keep this option enabled (`True`) for most DOCX processing tasks.
    *   **`prompt`:** **A very important parameter.** This is the instruction for the LLM.
        *   Edit the prompt text for your specific tasks (e.g., fix grammar and spelling, rewrite in a different style, summarize).
        *   The prompt must contain the placeholder `{text_chunk}`, where the text fragment will be inserted.
        *   The default Russian prompt is very conservative, aiming to minimize changes to the author's style. You might want to make it more or less assertive depending on your goal.
        *   **Important:** The default prompt is in Russian. If you are processing text in another language (e.g., English), **translate the prompt into that language**, including any instructions about preserving tags (or placeholders if using heuristics) and whitespace. LLM performance heavily depends on the language and clarity of the instructions.
    *   **`heuristics`:** Settings for heuristics (see below). Enabled/disabled by setting `True` or `False`.

## ‚ú® Heuristics

Heuristics are optional text transformations applied *before* sending to the LLM (preprocessing) and *after* receiving the response (postprocessing), designed to **improve processing quality**. Configured in the `config.yaml` file under the `heuristics` section.

*   **`remove_commas` (Preprocessing, only 1st pass):**
    *   **What it does:** Removes all commas from the chunk *before* sending it to the LLM (only on the first pass if `number_of_passes: 1`).
    *   **When to use:** Can potentially improve results if the original text has **many unnecessary or incorrectly placed commas**, and you want the model to re-punctuate it "from scratch". **Recommended for powerful models** (like `Gemini 1.5 Pro`, `Claude 3 Opus`) that are good at restoring punctuation.
    *   **Caveats:** Weaker models might fail to reinsert commas correctly or at all. Use with caution.
*   **`replace_tags_with_placeholder` (Preprocessing + Postprocessing):**
    *   **What it does:**
        *   *Preprocessing:* Finds all tags like `<...>` (e.g., `<p>`, `</emphasis>`, `<RUN123/>`) and replaces them with unique, simple placeholder symbols (e.g., `@`, `#`, `$`, or more complex unique markers). Information about the replaced tags and their order is stored.
        *   *Postprocessing:* After receiving the response from the LLM, replaces the placeholder symbols back with the original tags in the correct order.
    *   **When to use:** **Strongly recommended for FB2 and DOCX formats.** LLMs often struggle to preserve HTML/XML-like tags correctly. This heuristic effectively "hides" the tags from the LLM. **Weaker models (especially local ones) might completely fail to process tagged formats without this heuristic.**
    *   **Caveats:** If the LLM deletes or adds one of the placeholder symbols in the text, tag restoration will fail, and the tag validation check (`validate_response`) will likely raise an error. The prompt should instruct the LLM to keep these special symbols untouched.

## üöÄ Usage

1.  Place your book files (`.fb2`, `.txt`, `.docx`) in the same folder as the program executable (`.exe` or script) and the `config.yaml` file.
2.  Run the executable (`.exe`) or script (e.g., `python main.py`).
3.  The program will find compatible files in the current directory and start processing them one by one. You will see progress logs in the console, including chunk processing status, retries, and errors.
4.  Processed files will be saved in the folder specified by `processing.output_dir` (default is `output_books`), with the suffix `_rewritten` added to the original filename (e.g., `my_book_rewritten.fb2`).
5.  **Cache:** During processing, a `book_temp` folder is created. Inside, subfolders for each book store the processed chunks (e.g., `chunk00001.txt`, `chunk00002.txt`). If the process is interrupted (e.g., Ctrl+C, system shutdown, error), on the next run for the same book, the program will read these cached files and resume processing only the remaining chunks. **Optional:** After processing, you can open the original and `_rewritten` DOCX files in Word or Google Docs (using the comparison method described in "Important Notes") to review the changes made by the LLM.
6.  **Reset Cache:** If you want to reprocess a book from scratch (e.g., after changing the prompt, model, or other settings), simply delete the corresponding subfolder inside `book_temp` (e.g., delete `book_temp/my_book_name/`). The program will then process all chunks again on the next run.

## üîß Troubleshooting

*   **`RESOURCE_EXHAUSTED` (Error 429 in logs):** You are sending too many requests too quickly, exceeding your API rate limit, or you have exhausted your daily/monthly free quota or account balance. Decrease the `processing.workers_amount` in `config.yaml`, wait for the rate limit period to reset (often a minute or a day), or check your account balance/quota.
*   **Google Blocking Messages (Filter/Safety):** Google Gemini's safety filter was triggered (often indicated by `"finish_reason": "SAFETY"` in logs). See the "Important Notes" section regarding Content Filters. Try modifying the prompt to be less likely to trigger filters, use a model known for less aggressive filtering (like Flash), potentially adjust safety settings if the API allows, or switch providers (OpenRouter).
*   **`ValidationFailedError` (or similar tag validation errors):** The LLM modified the number or structure of tags (or placeholders, if using the `replace_tags_with_placeholder` heuristic). This often occurs if the heuristic is disabled for FB2/DOCX, or if the LLM (despite instructions) added/deleted a placeholder symbol. Sometimes it's a transient issue, and a retry (if `retry_if_failed: True`) might succeed. Ensure the heuristic is enabled for FB2/DOCX and the prompt clearly instructs the LLM to preserve tags/placeholders.
*   **Slow Processing:** Increase `processing.workers_amount` (carefully monitor for rate limit errors!) or consider increasing `processing.chunk_size` (trade-off with potential quality decrease). Using faster models (like Gemini Flash instead of Pro, or Haiku instead of Opus) can also significantly speed up processing. Check your network connection as well.
*   **`500 Internal Server Error` (or similar 5xx errors):** This usually indicates a temporary problem on the LLM provider's side. If `retry_if_failed: True`, the program should automatically retry after a delay. If errors persist, check the provider's status page or try again later.

## üìÑ License

This project is distributed under the MIT License. See the `LICENSE` file for details.